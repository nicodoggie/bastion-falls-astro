---
import type { CharacterSexOrgan } from '@bastion-falls/types/Character';
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';
import { getEntries } from 'astro:content';
import { getCollection } from 'astro:content';
import { type CollectionEntry, getEntry,  } from 'astro:content';
import { slug } from 'github-slugger';

const { character } = Astro.props;

let image;
if(character?.image?.url) {
  const images = import.meta.glob<{default: ImageMetadata}>("/src/assets/**/*.{jpg,jpeg,png,webp}");
  image =  images[character.image.url]();
}

let mortalityIcon;
switch(character.details.mortality) {
  case 'dead':
    mortalityIcon = 'ðŸ’€';
    break;
  case 'alive':
    mortalityIcon = '';
    break;
  case 'undead':
    mortalityIcon = 'ðŸ§Ÿ';
    break;
  case 'unknown':
    mortalityIcon = 'ï¿½';
    break;
}

let species;
if(character?.details?.species) {
  if(! Array.isArray(character.details.species)) {
    species = [await getEntry('species', slug(character.details.species))];
  } else {
    species = await Promise.all(
      character.details.species.map(
        async (species: string) => await getEntry('species', slug(species))
      )
    );
  }
}

interface Relative {
  type: string;
  entry: CollectionEntry<"character">;
}


let relatives: Relative[] = [];
if(character?.relationships?.relatives) {
  relatives = await Promise.all(
    character.relationships.relatives.map(
      async ({name, type}: {name: string, type: string}) => {
        const relativeEntry = await getEntry('character', slug(name)); 
        return {type, entry: relativeEntry};
      }
    )
  )
}
// Sort by relative type
relatives.sort((a, b) => a.type.localeCompare(b.type));
interface Organization {
  name: string;
  title: string;
}
let organizations: {title: string, entry: CollectionEntry<"organization">}[] = [];
if(character?.relationships?.organizations) {
  organizations = (await Promise.all(
    character.relationships.organizations.map(
      async (organization: Organization) => {
        const sluggedName = slug(organization.name);
        const organizationEntry = await getEntry('organization', sluggedName);
        return {title: organization.title, entry: organizationEntry};
      }
    )
  )).filter((organization) => organization && organization.entry);
}

let families: CollectionEntry<"family">[] = [];
if(character?.relationships?.families) {
  families = await Promise.all(
    character.relationships.families.map(
      async (family: string) => {
        const familyEntry = await getEntry('family', slug(family));
        return familyEntry;
      }
  ))
}

---
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 w-full max-w-full">
  {
    character.name && (
      <div class="flex justify-center items-center border-gray-600">
        <a href={character.ddb} target="_blank" rel="noopener noreferrer">
          <h2 class="text-xl text-center font-bold text-gray-900 dark:text-white" style="display: inline-block;">
            {character.name}<span class="mortality-icon p-1">{mortalityIcon}</span>
          </h2>
        </a>
      </div>
      <hr class="border-gray-600">
    )
  }
  {
    image && (
      <div class="mb-4 w-full character-image-container bg-black">
        <Image 
          src={image} 
          alt={character.image.alt || character.name || ""} 
          title={character.image.attribution}
          class="w-full h-full max-h-48 rounded-lg object-scale-down block mx-auto"
        />
        <p class="text-xs text-gray-500 mt-1 text-center">
          <a href={character.image.attributionUrl} target="_blank" rel="noopener noreferrer">
            {character.image.attribution}
          </a>
        </p>
      </div>
    )
  }

  <div class="space-y-4">
    <dl class="divide-y divide-gray-200 dark:divide-gray-700">
      
      {
        character.details?.age && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Age
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.details.age}
            </dd>
          </div>
        )
      }
      {
        character.details?.dateOfBirth && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Date of Birth
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.details.dateOfBirth}
            </dd>
          </div>
        )
      }
      {
        character.details?.dateOfDeath && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Date of Death
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.details.dateOfDeath}
            </dd>
          </div>
        )
      }
      {
        character?.details.sex && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Sex
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.details.sex}{character.details.pronouns && ` (${character.details.pronouns})`}
            </dd>
          </div>
        )
      }
      {
        character?.details.sexOrgans && character.details.sexOrgans.length > 0 `&& (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Genitalia
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              <dl>
                {character.details.sexOrgans.map((organ: CharacterSexOrgan) => (
                  <div>
                    {organ.type === "penis" && (
                      <>
                        Penis
                        <dl class="ml-4">
                          {organ.length && <dt>Length</dt> && <dd>{organ.length}</dd>}
                          {organ.girth && <dt>Girth</dt> && <dd>{organ.girth}</dd>}
                          {organ.pubicHair && <dt>Pubic Hair</dt> && <dd>{organ.pubicHair}</dd>}
                        </dl>
                      </>
                    )}
                    {organ.type === "vagina" && (
                      <>
                        Vagina
                        <dl class="ml-4">
                          {organ.depth && <dt>Depth</dt> && <dd>{organ.depth}</dd>}
                          {organ.width && <dt>Width</dt> && <dd>{organ.width}</dd>}
                          {organ.pubicHair && <dt>Pubic Hair</dt> && <dd>{organ.pubicHair}</dd>}
                        </dl>
                      </>
                    )}
                    {organ.type === "breasts" && (
                      <>
                        Breasts
                        <dl class="ml-4">
                          {organ.size && <dt>Size</dt> && <dd>{organ.size}</dd>}
                          {organ.nipples && <dt>Nipples</dt> && <dd>{organ.nipples}</dd>}
                        </dl>
                      </>
                    )}
                  </div>
                ))}
              </dl>
            </dd>
          </div>
        )
      }
      {
        character.details?.origin && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Origin
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.details.origin}
            </dd>
          </div>
        )
      }
      {
        character.background?.alignment && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Alignment
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.background.alignment.moral}{' '}
              {character.background.alignment.law}
            </dd>
          </div>
        )
      }
      {
        character.details?.aliases && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Known Aliases
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.details.aliases.join(', ')}
            </dd>
          </div>
        )
      }
      {
        organizations && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Organizations
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              <ul>
                {organizations.map(
                  ({title, entry}: {title: string, entry: CollectionEntry<"organization"> | undefined}) => (
                    <li>
                      <a href={`/organizations/${entry?.id}`}>{entry?.data.title} {title && `(${title})`}</a>
                    </li>
                  )
                )}
              </ul>
            </dd>
          </div>
        )
      }
      {
        relatives && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Relatives
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              <ul>
                {relatives.map((relative: Relative) => {
                  return (
                  <li>
                    <a href={`/characters/${relative.entry?.id}`}>
                      {relative.entry?.data.title}
                      {relative.type && ` (${relative.type})`}
                    </a>
                  </li>
                  );
                })}
              </ul>
            </dd>
          </div>
        )
      }
      
      {
        families && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Families
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              <ul>
                {families.map((family: CollectionEntry<"family">) => (
                  <li>
                    <a href={`/families/${family?.id}`}>{family?.data.family.name}</a>
                  </li>
                ))}
              </ul>
            </dd>
          </div>
        )
      }
      {
        character.details?.species && species && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Species
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              <ul>
                {species.map((species: CollectionEntry<"species">) => (
                  <li>
                    <a href={`/species/${species.id}`}>{species.data.title}</a>
                  </li>
                ))}
              </ul>
            </dd>
          </div>
        )
      }
      {
        character.details?.height && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Height
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.details.height}
            </dd>
          </div>
        )
      }
      {
        character.details?.weight && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Weight
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.details.weight}
            </dd>
          </div>
        )
      }
      {
        character.background?.goals && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Goals
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.background.goals}
            </dd>
          </div>
        )
      }
      {
        character.background?.flaws && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Flaws
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.background.flaws}
            </dd>
          </div>
        )
      }
      {
        character.background?.backstory && (
          <div class="py-2">
            <dt class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Backstory
            </dt>
            <dd class="text-gray-600 dark:text-gray-400">
              {character.background.backstory}
            </dd>
          </div>
        )
      }
    </dl>
  </div>
</div>
