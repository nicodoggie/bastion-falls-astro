---
import { getCollection } from 'astro:content';
import BlogIndex from '@/components/blog/BlogIndex.astro';

const posts = await getCollection('posts');

// Sort posts: published first, newest to oldest by published date
const allPosts = posts.sort((a, b) => {
  const aIsDraft = a.data.draft === true;
  const bIsDraft = b.data.draft === true;

  if (aIsDraft && !bIsDraft) return 1; // drafts after published
  if (!aIsDraft && bIsDraft) return -1; // published before drafts

  // Both published (draft false/undefined): sort by published desc (newest first)
  if (a.data.draft === false && b.data.draft === false) {
    return b.data.published.valueOf() - a.data.published.valueOf();
  }

  // Both drafts: keep relative order (or customize later if needed)
  return 0;
});

// Tag list for sidebar/dropdown
const tagSet = new Set<string>();
for (const p of allPosts) (p.data.tags ?? []).forEach((t: string) => tagSet.add(t));
const allTags = Array.from(tagSet).sort((a, b) => a.localeCompare(b));
---

<BlogIndex 
  posts={allPosts}
  title="Blog"
  description="Thoughts, poems, and other musings during the development of the Bastion Falls D&D campaign."
  showDraftToggle={true}
  allTags={allTags}
  backLink={{ href: "/welcome/", text: "← Main Site" }}
/>
